services:
  api:
    build: .
    restart: unless-stopped
    network_mode: host
    env_file: .env
    environment:
      - OLLAMA_BASE_URL=http://127.0.0.1:11434
    volumes:
      - /mnt/nvme0n1p1/mimir:/data
      - /mnt/storage2:/data/documents:ro

  # ── LLM extraction worker ──────────────────────────────────
  # Consumes the run queue and processes chunks through the LLM.
  # Scale horizontally: docker compose up --scale llm-worker=3
  llm-worker:
    build: .
    restart: on-failure
    command: ["python", "-m", "mimir.worker.llm_worker"]
    env_file: .env
    environment:
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - LLM_WORKER_CONCURRENCY=3
    volumes:
      - /mnt/nvme0n1p1/mimir:/data
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ── Feedly connector worker ────────────────────────────────
  feedly-worker:
    build: .
    restart: on-failure
    command: ["python", "-m", "mimir.worker.feedly_worker"]
    env_file: .env
    environment:
      - FEEDLY_WORKER_INTERVAL_MINUTES=30
      - FEEDLY_QUEUE_FOR_LLM=1
    volumes:
      - /mnt/nvme0n1p1/mimir:/data
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ── OpenCTI connector worker ───────────────────────────────
  opencti-worker:
    build: .
    restart: on-failure
    command: ["python", "-m", "mimir.worker.opencti_worker"]
    env_file: .env
    environment:
      - OPENCTI_WORKER_INTERVAL_MINUTES=30
    volumes:
      - /mnt/nvme0n1p1/mimir:/data
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ── Public RSS threat feed worker ──────────────────────────
  rss-worker:
    build: .
    restart: on-failure
    command: ["python", "-m", "mimir.worker.rss_worker"]
    env_file: .env
    environment:
      - RSS_WORKER_ENABLED=0
      - RSS_WORKER_INTERVAL_MINUTES=30
    volumes:
      - /mnt/nvme0n1p1/mimir:/data
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ── GVM/OpenVAS vulnerability worker ───────────────────────
  gvm-worker:
    build: .
    restart: on-failure
    command: ["python", "-m", "mimir.worker.gvm_worker"]
    env_file: .env
    environment:
      - GVM_WORKER_ENABLED=0
      - GVM_WORKER_INTERVAL_MINUTES=30
      - GVM_WORKER_LOOKBACK_MINUTES=180
    volumes:
      - /mnt/nvme0n1p1/mimir:/data
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ── Watcher threat-intelligence worker ─────────────────────
  watcher-worker:
    build: .
    restart: on-failure
    command: ["python", "-m", "mimir.worker.watcher_worker"]
    env_file: .env
    environment:
      - WATCHER_WORKER_ENABLED=0
      - WATCHER_WORKER_INTERVAL_MINUTES=30
      - WATCHER_WORKER_LOOKBACK_MINUTES=180
    volumes:
      - /mnt/nvme0n1p1/mimir:/data
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ── Elasticsearch source worker ────────────────────────────
  elastic-worker:
    build: .
    restart: on-failure
    command: ["python", "-m", "mimir.worker.elastic_worker"]
    env_file: .env
    environment:
      - ELASTIC_WORKER_INTERVAL_MINUTES=30
      - ELASTIC_WORKER_EXCLUDE_INDICES=feedly_news
    volumes:
      - /mnt/nvme0n1p1/mimir:/data
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ── Malware feed worker ────────────────────────────────────
  malware-worker:
    build: .
    restart: on-failure
    command: ["python", "-m", "mimir.worker.malware_worker"]
    env_file: .env
    environment:
      - MALWARE_WORKER_ENABLED=1
      - MALWARE_WORKER_INTERVAL_MINUTES=30
      - MALWARE_WORKER_INDICES=mwdb-openrelik,dailymalwarefeed-*
      - MALWARE_WORKER_LOOKBACK_MINUTES=525600
      - MALWARE_WORKER_MAX_PER_INDEX=50000
    volumes:
      - /mnt/nvme0n1p1/mimir:/data
    extra_hosts:
      - "host.docker.internal:host-gateway"

  backfill:
    build: .
    profiles: ["backfill"]
    command: ["python", "-m", "mimir.backfill"]
    env_file: .env
    volumes:
      - /mnt/nvme0n1p1/mimir:/data
    extra_hosts:
      - "host.docker.internal:host-gateway"
